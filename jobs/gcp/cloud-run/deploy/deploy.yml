deploy:
  needs: build
  name: Deploy to Google Cloud Run
  runs-on: ubuntu-latest
  permissions:
    contents: "read"
    id-token: "write"
  env:
    REGISTRY: ((registry_url))
    GCP_PROJECT: ((gcp_project))
  steps:
    - name: Checkout branch
      uses: actions/checkout@v4
    - name: Set image and service name
      run: |
        sed -i -e 's%${IMAGE_NAME}%'"$IMAGE_NAME"'%g' service.yaml
        sed -i -e 's%${GCP_PROJECT}%'"$GCP_PROJECT"'%g' service.yaml
      env:
        IMAGE_NAME: "${{ env.REGISTRY }}/${{ github.event.repository.name }}:${{ github.sha }}"
    - id: auth
      name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ((credentials_json_secret_string))
    - id: deploy
      name: Deploy to Cloud Run
      uses: google-github-actions/deploy-cloudrun@v2
      with:
        metadata: service.yaml
