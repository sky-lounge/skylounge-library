---
steps:
  - name: Extract Manifest values
    id: manifest
    uses: pietrobolcato/action-read-yaml@1
    with:
      config: ${{ github.workspace }}/${{ env.MANIFEST }}
    env:
      MANIFEST: ((cf_manifest))
  - name: Install Cloud Foundry CLI
    run: |
      mkdir cf-cli
      cd cf-cli
      curl -L "https://packages.cloudfoundry.org/stable?release=linux64-binary&version=v8&source=github" | tar -zx
      rm cf
      mv cf8 cf
      chmod +x cf
  - name: Deploy
    id: deploy
    run: |
      cf-cli/cf api $API
      cf-cli/cf auth
      cf-cli/cf target -o $ORG -s $SPACE
      cf-cli/cf push -f $MANIFEST --strategy rolling
      app_name=${{ steps.manifest.outputs['applications.0.name'] }}
      cf-cli/cf set-label app $app_name "commit=${{ github.sha }}"
      route=${{ steps.manifest.outputs['applications.0.routes.0.route'] }}
      echo "route=${route}" >> $GITHUB_OUTPUT
    env:
      API: ((cf_api))
      CF_USERNAME: ((cf_username))
      CF_PASSWORD: ((cf_password))
      ORG: ((cf_org))
      SPACE: ((cf_space))
      MANIFEST: ((cf_manifest))
